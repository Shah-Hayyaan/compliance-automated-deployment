name: Dev Environment Deploy

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]
  workflow_dispatch:

env:
  TF_VAR_environment: dev
  WORKING_DIR: environments/dev
  TERRAFORM_VERSION: "1.5.0"

jobs:
  validate:
    name: Validate Build
    runs-on: ubuntu-latest
    outputs:
      validation_success: "true"
      build_artifact_name: "build-artifacts-dev-${{ github.sha }}-${{ github.run_number }}"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Mock validation
        run: |
          echo "âœ… Validation passed"
          echo "validation_success=true" >> $GITHUB_OUTPUT
        id: validate
      
      - name: Create mock build artifacts
        run: |
          mkdir -p build-output
          echo "Mock build artifact" > build-output/app.zip
          echo "Build completed at $(date)" > build-output/build-info.txt
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "build-artifacts-dev-${{ github.sha }}-${{ github.run_number }}"
          path: build-output/
          retention-days: 30

  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push' && needs.validate.outputs.validation_success == 'true'
    environment: 
      name: dev
      url: https://dev-internal.company.local
    outputs:
      deployment_success: ${{ steps.deploy.outputs.deployment_success }}
      deployment_artifact_name: ${{ steps.deploy_artifact.outputs.deployment_artifact_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.validate.outputs.build_artifact_name }}
          path: ${{ env.WORKING_DIR }}/build-artifacts

      - name: Setup Terraform configuration
        run: |
          # Ensure directory exists
          mkdir -p ${{ env.WORKING_DIR }}
          
          # Create main.tf with basic configuration
          cat > ${{ env.WORKING_DIR }}/main.tf << 'EOF'
          terraform {
            required_version = ">= 1.0"
            required_providers {
              local = {
                source  = "hashicorp/local"
                version = "~> 2.0"
              }
            }
          }

          # Create a simple local file to simulate deployment
          resource "local_file" "deployment_info" {
            content = jsonencode({
              environment    = var.environment
              commit_sha     = var.commit_sha
              build_number   = var.build_number
              deployed_at    = timestamp()
              bucket_name    = var.bucket_name
              region         = var.region
              tags           = var.common_tags
            })
            filename = "${path.module}/deployment-info.json"
          }
          EOF

          # Create variables.tf
          cat > ${{ env.WORKING_DIR }}/variables.tf << 'EOF'
          variable "environment" {
            description = "Environment name"
            type        = string
          }

          variable "commit_sha" {
            description = "Git commit SHA"
            type        = string
          }

          variable "build_number" {
            description = "Build number"
            type        = string
          }

          variable "bucket_name" {
            description = "Name of the S3 bucket"
            type        = string
            default     = "default-dev-bucket"
          }

          variable "common_tags" {
            description = "Tags to apply to all resources"
            type        = map(string)
            default     = {
              "env"  = "dev"
              "team" = "platform"
            }
          }

          variable "region" {
            description = "AWS Region"
            type        = string
            default     = "us-east-1"
          }
          EOF

          # Create outputs.tf
          cat > ${{ env.WORKING_DIR }}/outputs.tf << 'EOF'
          output "environment" {
            description = "Current environment"
            value       = var.environment
          }

          output "deployment_timestamp" {
            description = "Timestamp of deployment"
            value       = timestamp()
          }

          output "commit_sha" {
            description = "Git commit SHA"
            value       = var.commit_sha
          }

          output "build_number" {
            description = "Build number"
            value       = var.build_number
          }

          output "deployment_file_path" {
            description = "Path to deployment info file"
            value       = local_file.deployment_info.filename
          }
          EOF

      - name: Terraform Init
        run: |
          echo "Initializing Terraform for deployment..."
          terraform init -no-color
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Plan
        run: |
          echo "Planning Terraform changes..."
          terraform plan -no-color \
            -var="environment=dev" \
            -var="commit_sha=${{ github.sha }}" \
            -var="build_number=${{ github.run_number }}"
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Apply
        id: deploy
        run: |
          echo "Applying Terraform changes..."
          if terraform apply -auto-approve -no-color \
            -var="environment=dev" \
            -var="commit_sha=${{ github.sha }}" \
            -var="build_number=${{ github.run_number }}"; then
            echo "deployment_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment successful"
          else
            echo "deployment_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Deployment failed"
            exit 1
          fi
        working-directory: ${{ env.WORKING_DIR }}

      - name: Generate deployment report
        id: deploy_artifact
        run: |
          DEPLOYMENT_ARTIFACT_NAME="deployment-artifacts-dev-${{ github.sha }}-${{ github.run_number }}"
          echo "deployment_artifact_name=$DEPLOYMENT_ARTIFACT_NAME" >> $GITHUB_OUTPUT
          
          echo "# ðŸš€ Dev Deployment Report" > deployment-report.md
          echo "## ðŸ“‹ Deployment Details" >> deployment-report.md
          echo "- **Environment:** dev" >> deployment-report.md
          echo "- **Timestamp:** $(date)" >> deployment-report.md
          echo "- **Commit SHA:** ${{ github.sha }}" >> deployment-report.md
          echo "- **Build Number:** ${{ github.run_number }}" >> deployment-report.md
          echo "- **Triggered by:** ${{ github.actor }}" >> deployment-report.md
          echo "- **Status:** âœ… Deployed Successfully" >> deployment-report.md
          echo "- **Environment URL:** https://dev-internal.company.local" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## ðŸŽ¯ Ready for UAT Promotion" >> deployment-report.md
          echo "This build has been successfully deployed to the dev environment and is ready to be promoted to UAT." >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Deployment Artifacts" >> deployment-report.md
          echo "- Build artifacts processed: âœ…" >> deployment-report.md
          echo "- Infrastructure updated: âœ…" >> deployment-report.md
          echo "- Configuration applied: âœ…" >> deployment-report.md
          
          # Generate Terraform outputs
          terraform output -json > tf-outputs.json 2>/dev/null || echo '{"environment": {"value": "dev"}}' > tf-outputs.json
          
          # Create a mock terraform state summary (don't export actual state for security)
          echo '{"format_version": "1.0", "terraform_version": "1.5.0", "values": {"outputs": {"environment": {"value": "dev"}}}}' > terraform-state-summary.json
        working-directory: ${{ env.WORKING_DIR }}

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.deploy_artifact.outputs.deployment_artifact_name }}
          path: |
            ${{ env.WORKING_DIR }}/deployment-report.md
            ${{ env.WORKING_DIR }}/terraform-state-summary.json
            ${{ env.WORKING_DIR }}/tf-outputs.json
            ${{ env.WORKING_DIR }}/deployment-info.json
          retention-days: 90

      - name: Notify UAT promotion readiness
        run: |
          echo "ðŸŽ‰ Dev deployment completed successfully!"
          echo "ðŸ“¦ Deployment artifact: ${{ steps.deploy_artifact.outputs.deployment_artifact_name }}"
          echo "ðŸ”„ This build is now ready for UAT promotion via pull request"
          echo "ðŸ“ Create a PR from dev â†’ uat to promote this deployment"

  promote-to-uat:
    name: Prepare UAT Promotion
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.deployment_success == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create UAT promotion branch
        run: |
          BRANCH_NAME="promote-to-uat-${{ github.sha }}-${{ github.run_number }}"
          git checkout -b $BRANCH_NAME
          
          # Create a promotion file to track the deployment
          mkdir -p .github/promotions
          cat > .github/promotions/dev-to-uat-${{ github.run_number }}.json << EOF
          {
            "source_environment": "dev",
            "target_environment": "uat", 
            "commit_sha": "${{ github.sha }}",
            "build_number": "${{ github.run_number }}",
            "deployment_artifact": "${{ needs.deploy.outputs.deployment_artifact_name }}",
            "promoted_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "promoted_by": "${{ github.actor }}",
            "status": "ready_for_promotion"
          }
          EOF
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .github/promotions/
          git commit -m "ðŸš€ Prepare promotion: dev â†’ uat (build ${{ github.run_number }})"
          
          echo "âœ… Created promotion branch: $BRANCH_NAME"
          echo "ðŸ”„ Ready to create pull request for UAT deployment"
